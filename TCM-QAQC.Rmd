---
title: "TCM-QAQC"
author: "Christina Bonsell"
date: "October 16, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

# A cleaned-up version of [TCMworkup-from-raw.Rmd](https://cbonsell.github.io/ble-instrumentation/TCMworkup-from-raw) that only returns final dataset and plots

[R script for this document](https://github.com/cbonsell/ble-instrumentation/blob/master/TCM-QAQC.Rmd)

[R script for workup document](https://github.com/cbonsell/ble-instrumentation/blob/master/TCMworkup-from-raw.Rmd)

Important info

* Looks like JALD2 got knocked out by ice?
    + JALD2 after 2018-08-27 04:00:00 flagged as **BAD**

* Suspiciously high currents at EELD1 June 29- Jul4 
    + EELD1 between 2019-06-29 05:00:00 and 2019-07-04 20:00:00 flagged as **QM** (questionable)

* EWLD1 battery died June 15 2019


Final table: [BLE LTER TCM2018to2019.csv](https://github.com/cbonsell/ble-instrumentation/blob/master/results/BLE%20LTER%20TCM2018to2019.csv)


##Code and Plots

Required packages:

```{r libs, message=FALSE}
library(tidyverse)
library(oce)
library(cowplot)
```


Read in data

```{r, message=FALSE, warning=FALSE}
TCM_Curr <- read_csv("TCMcurrent_condensed_raw.csv") %>% select(-X1)
TCM_Temp <- read_csv("TCMtemperature_condensed_raw.csv") %>% select(-X1)
```


Flag JALD2 and EELD1

```{r flags}
#data is actually in US/Alaska time, but we want easy to work with code :)


TCM_Curr<-TCM_Curr%>%
  mutate(flags=
           case_when(Station=="JALD2"& DT>as.POSIXct("2018-08-27 01:00:00", tz="UTC")~"BAD",
                    Station=="EELD1"& DT>as.POSIXct("2019-06-29 05:00:00", tz="UTC")&DT<as.POSIXct("2019-07-04 20:00:00", tz="UTC") ~"QM"))

```

Final plots

```{r plot, fig.width=11, fig.height=8, fig.fullwidth=TRUE}
ggplot(TCM_Curr, aes(DT, Speed_cm_s))+
  geom_point(aes(color=flags))+
  facet_wrap(~Station, scales="free")+
  theme_cowplot()

ggplot(TCM_Curr, aes(DT))+
  geom_line(aes(y=Vel_N,color="Vel_N"))+
  geom_line(aes(y=Vel_E,color="Vel_E"))+
  facet_wrap(~Station, scales="free")+
  theme_cowplot()+
  scale_color_manual(breaks = c("Vel_N", "Vel_E"),values = c("Vel_N"="black", "Vel_E"="blue"))


ggplot(TCM_Temp, aes(DT, Temperature))+
  geom_line(aes(color=Station))+
  theme_cowplot()
```

write table

```{r}
TCM2018to2019 <- full_join(TCM_Temp,TCM_Curr,by=c("Station","DT")) %>% 
  select(-flags,flags) #this join will be conservative (final table will not include temps for which there aren't current measurements)

write.csv(TCM2018to2019, "BLE LTER TCM2018to2019.csv")
```

